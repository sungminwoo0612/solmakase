# 4. 데이터베이스 설계

---

## 4.1 DB 스키마 설계

### 주요 테이블 구조

#### 1. users (사용자)
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2. requirements (요구사항)
```sql
CREATE TABLE requirements (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    input_type VARCHAR(50) NOT NULL, -- 'survey', 'document', 'chat', 'expert'
    service_type VARCHAR(100),
    deployment_type VARCHAR(50), -- 'onprem', 'cloud', 'hybrid'
    scale VARCHAR(50), -- 'small', 'medium', 'large'
    budget DECIMAL(15, 2),
    has_ops_team BOOLEAN,
    special_requirements TEXT,
    structured_data JSONB, -- 구조화된 요구사항 데이터
    status VARCHAR(50) DEFAULT 'pending', -- 'pending', 'analyzing', 'completed', 'failed'
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3. documents (문서)
```sql
CREATE TABLE documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    requirement_id UUID NOT NULL REFERENCES requirements(id) ON DELETE CASCADE,
    file_name VARCHAR(255) NOT NULL,
    file_type VARCHAR(50) NOT NULL, -- 'pdf', 'docx', 'pptx', 'hwp'
    file_size BIGINT NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    extracted_text TEXT,
    parsed_data JSONB, -- 파싱된 구조화 데이터
    status VARCHAR(50) DEFAULT 'uploaded', -- 'uploaded', 'parsing', 'parsed', 'failed'
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP -- 7일 후 자동 삭제
);
```

#### 4. chat_messages (채팅 메시지)
```sql
CREATE TABLE chat_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    requirement_id UUID NOT NULL REFERENCES requirements(id) ON DELETE CASCADE,
    role VARCHAR(20) NOT NULL, -- 'user', 'assistant'
    message TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 5. infrastructure_designs (인프라 설계)
```sql
CREATE TABLE infrastructure_designs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    requirement_id UUID NOT NULL REFERENCES requirements(id) ON DELETE CASCADE,
    design_type VARCHAR(50) NOT NULL, -- 'onprem', 'cloud', 'hybrid'
    provider VARCHAR(50), -- 'aws', 'azure', 'gcp', 'onprem'
    architecture JSONB NOT NULL, -- 인프라 아키텍처 구조
    cost_estimate JSONB, -- 비용 산정 정보
    plan_document TEXT, -- 인프라 기획안 텍스트
    status VARCHAR(50) DEFAULT 'draft', -- 'draft', 'approved', 'deployed'
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 6. iac_codes (IaC 코드)
```sql
CREATE TABLE iac_codes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    infrastructure_design_id UUID NOT NULL REFERENCES infrastructure_designs(id) ON DELETE CASCADE,
    iac_tool VARCHAR(50) NOT NULL, -- 'terraform', 'ansible', 'kubernetes'
    version INTEGER NOT NULL DEFAULT 1,
    code_content TEXT NOT NULL,
    validation_status VARCHAR(50) DEFAULT 'pending', -- 'pending', 'valid', 'invalid'
    validation_errors JSONB,
    is_current BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(100) -- 'system', 'user_prompt'
);
```

#### 7. deployments (배포)
```sql
CREATE TABLE deployments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    infrastructure_design_id UUID NOT NULL REFERENCES infrastructure_designs(id) ON DELETE CASCADE,
    iac_code_id UUID NOT NULL REFERENCES iac_codes(id),
    status VARCHAR(50) DEFAULT 'pending', -- 'pending', 'deploying', 'success', 'failed', 'rolled_back'
    deployment_log TEXT,
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 8. resources (리소스)
```sql
CREATE TABLE resources (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    deployment_id UUID NOT NULL REFERENCES deployments(id) ON DELETE CASCADE,
    resource_type VARCHAR(100) NOT NULL, -- 'ec2', 'rds', 's3', 'vpc', etc.
    resource_name VARCHAR(255) NOT NULL,
    resource_id VARCHAR(255), -- 클라우드 리소스 ID
    configuration JSONB, -- 리소스 설정 정보
    status VARCHAR(50) DEFAULT 'unknown', -- 'running', 'stopped', 'error', 'unknown'
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 9. monitoring_metrics (모니터링 메트릭)
```sql
CREATE TABLE monitoring_metrics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    resource_id UUID NOT NULL REFERENCES resources(id) ON DELETE CASCADE,
    metric_name VARCHAR(100) NOT NULL, -- 'cpu_usage', 'memory_usage', 'network_in', etc.
    metric_value DECIMAL(15, 4) NOT NULL,
    unit VARCHAR(50), -- 'percent', 'bytes', 'count', etc.
    collected_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_monitoring_metrics_resource_collected 
ON monitoring_metrics(resource_id, collected_at DESC);
```

#### 10. cost_tracking (비용 추적)
```sql
CREATE TABLE cost_tracking (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    deployment_id UUID NOT NULL REFERENCES deployments(id) ON DELETE CASCADE,
    resource_id UUID REFERENCES resources(id) ON DELETE SET NULL,
    cost_amount DECIMAL(15, 4) NOT NULL,
    currency VARCHAR(10) DEFAULT 'KRW',
    period_start TIMESTAMP NOT NULL,
    period_end TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## 4.2 ERD 설계

### 엔티티 관계도

```
┌─────────────┐
│    users    │
│─────────────│
│ id (PK)     │
│ email       │
│ name        │
└──────┬──────┘
       │ 1
       │
       │ N
┌──────▼──────────────┐
│   requirements      │
│─────────────────────│
│ id (PK)             │
│ user_id (FK)        │──┐
│ input_type          │  │
│ structured_data     │  │
│ status              │  │
└──────┬──────────────┘  │
       │ 1                │
       │                  │
       │ N                │
┌──────▼──────────────┐  │
│    documents        │  │
│─────────────────────│  │
│ id (PK)             │  │
│ requirement_id (FK) │──┘
│ file_name           │
│ extracted_text      │
└─────────────────────┘

┌─────────────┐
│requirements │
└──────┬──────┘
       │ 1
       │
       │ N
┌──────▼──────────────┐
│  chat_messages      │
│─────────────────────│
│ id (PK)             │
│ requirement_id (FK) │
│ role                │
│ message             │
└─────────────────────┘

┌─────────────┐
│requirements │
└──────┬──────┘
       │ 1
       │
       │ N
┌──────▼──────────────────┐
│ infrastructure_designs   │
│──────────────────────────│
│ id (PK)                  │
│ requirement_id (FK)      │──┐
│ design_type              │  │
│ architecture (JSONB)     │  │
│ cost_estimate (JSONB)    │  │
└──────┬───────────────────┘  │
       │ 1                      │
       │                        │
       │ N                      │
┌──────▼──────────────┐        │
│     iac_codes       │        │
│─────────────────────│        │
│ id (PK)             │        │
│ design_id (FK)      │────────┘
│ iac_tool            │
│ version             │
│ code_content        │
└──────┬──────────────┘
       │ 1
       │
       │ N
┌──────▼──────────────┐
│   deployments       │
│─────────────────────│
│ id (PK)             │
│ design_id (FK)      │
│ iac_code_id (FK)    │
│ status              │
└──────┬──────────────┘
       │ 1
       │
       │ N
┌──────▼──────────────┐
│    resources        │
│─────────────────────│
│ id (PK)             │
│ deployment_id (FK)  │──┐
│ resource_type       │  │
│ resource_id         │  │
│ configuration       │  │
└──────┬──────────────┘  │
       │ 1                │
       │                  │
       │ N                │
┌──────▼──────────────┐  │
│ monitoring_metrics  │  │
│─────────────────────│  │
│ id (PK)             │  │
│ resource_id (FK)    │──┘
│ metric_name         │
│ metric_value        │
│ collected_at        │
└─────────────────────┘

┌─────────────┐
│deployments  │
└──────┬──────┘
       │ 1
       │
       │ N
┌──────▼──────────────┐
│   cost_tracking     │
│─────────────────────│
│ id (PK)             │
│ deployment_id (FK)  │
│ resource_id (FK)    │
│ cost_amount         │
│ period_start        │
│ period_end          │
└─────────────────────┘
```

### 주요 관계

1. **users → requirements** (1:N)
   - 한 사용자는 여러 요구사항을 가질 수 있음

2. **requirements → documents** (1:N)
   - 한 요구사항에 여러 문서가 첨부될 수 있음

3. **requirements → chat_messages** (1:N)
   - 한 요구사항에 여러 채팅 메시지가 연결됨

4. **requirements → infrastructure_designs** (1:N)
   - 한 요구사항에 여러 설계안(온프레미스/클라우드)이 생성될 수 있음

5. **infrastructure_designs → iac_codes** (1:N)
   - 한 설계안에 여러 버전의 IaC 코드가 생성될 수 있음

6. **infrastructure_designs → deployments** (1:N)
   - 한 설계안에 여러 배포 이력이 있을 수 있음

7. **deployments → resources** (1:N)
   - 한 배포에 여러 리소스가 생성됨

8. **resources → monitoring_metrics** (1:N)
   - 한 리소스에 여러 시점의 메트릭 데이터가 수집됨

---

## 4.3 데이터 모델링

### 개념적 데이터 모델 (CDM)

**주요 엔티티 및 속성:**

1. **사용자 (User)**
   - 식별자: email
   - 속성: 이름, 생성일시

2. **요구사항 (Requirement)**
   - 식별자: id
   - 속성: 입력 유형, 서비스 유형, 배포 유형, 규모, 예산, 구조화된 데이터
   - 관계: 사용자, 문서, 채팅, 설계안

3. **인프라 설계 (Infrastructure Design)**
   - 식별자: id
   - 속성: 설계 유형, 프로바이더, 아키텍처(JSON), 비용 산정(JSON)
   - 관계: 요구사항, IaC 코드, 배포

4. **IaC 코드 (IaC Code)**
   - 식별자: id, version
   - 속성: 도구 유형, 코드 내용, 검증 상태
   - 관계: 인프라 설계, 배포

5. **배포 (Deployment)**
   - 식별자: id
   - 속성: 상태, 배포 로그, 시작/완료 시간
   - 관계: 인프라 설계, IaC 코드, 리소스

6. **리소스 (Resource)**
   - 식별자: id
   - 속성: 리소스 유형, 리소스 ID, 설정(JSON), 상태
   - 관계: 배포, 모니터링 메트릭

### 논리적 데이터 모델 (LDM)

- **정규화 수준**: 3NF (제3정규형)
- **JSONB 활용**: 복잡한 구조화 데이터는 JSONB로 저장
  - `requirements.structured_data`: 구조화된 요구사항
  - `infrastructure_designs.architecture`: 인프라 아키텍처 구조
  - `infrastructure_designs.cost_estimate`: 비용 산정 정보
  - `resources.configuration`: 리소스 설정

### 물리적 데이터 모델 (PDM)

- **데이터베이스**: PostgreSQL 15.x+
- **인덱스 전략**:
  - Primary Key: 모든 테이블의 id
  - Foreign Key: 모든 참조 관계에 인덱스 자동 생성
  - 복합 인덱스: `monitoring_metrics(resource_id, collected_at DESC)`
  - 검색 최적화: `requirements(user_id, created_at DESC)`, `requirements(status)`

---

## 4.4 데이터 정제

### 데이터 품질 관리

#### 1. 입력 데이터 검증
- **요구사항 데이터**:
  - 필수 필드 검증 (service_type, deployment_type 등)
  - 데이터 타입 검증
  - 범위 검증 (예산, 규모 등)

- **문서 데이터**:
  - 파일 형식 검증 (PDF, docx, pptx, 한글만 허용)
  - 파일 크기 제한 (최대 50MB)
  - 파일 무결성 검증

#### 2. 데이터 정제 규칙
- **문서 텍스트 추출**:
  - 인코딩 변환 (UTF-8 통일)
  - 특수 문자 정제
  - 불필요한 공백 제거

- **구조화된 데이터**:
  - JSON 스키마 검증
  - 필수 필드 존재 확인
  - 데이터 타입 변환

#### 3. 데이터 보관 정책
- **문서 자동 삭제**: 분석 완료 후 7일 경과 시 `deleted_at` 설정
- **메트릭 데이터 보관**: 90일 이상 된 메트릭 데이터는 아카이빙 또는 삭제
- **배포 로그 보관**: 배포 완료 후 30일간 보관

---

## 4.5 데이터 정규화

### 정규화 수준: 3NF (제3정규형)

#### 1NF (제1정규형) 준수
- 모든 컬럼이 원자값(Atomic Value)을 가짐
- 반복 그룹 제거 (JSONB로 구조화된 데이터는 별도 처리)

#### 2NF (제2정규형) 준수
- 부분 함수 종속성 제거
- 모든 비주요 속성이 기본키에 완전 함수 종속

#### 3NF (제3정규형) 준수
- 이행 함수 종속성 제거
- 비주요 속성 간의 종속성 제거

### 비정규화 고려 사항

#### JSONB 사용 이유
다음 필드는 복잡한 구조를 가지므로 JSONB로 저장 (의도적 비정규화):

1. **requirements.structured_data**
   - 이유: 요구사항 구조가 다양하고 변경 가능성이 높음
   - 장점: 유연한 스키마, 빠른 조회

2. **infrastructure_designs.architecture**
   - 이유: 인프라 구조가 복잡하고 중첩된 구조를 가짐
   - 장점: 전체 아키텍처를 한 번에 조회 가능

3. **resources.configuration**
   - 이유: 리소스별로 설정 항목이 다름
   - 장점: 리소스 타입별로 다른 설정 구조 저장 가능

#### 인덱스 전략
- **B-Tree 인덱스**: 기본 키, 외래 키, 자주 조회되는 컬럼
- **GIN 인덱스**: JSONB 컬럼에 대한 인덱싱 (선택적)
- **Partial 인덱스**: 특정 조건의 데이터만 인덱싱 (예: `is_current = TRUE`인 IaC 코드)

### 성능 최적화

1. **파티셔닝 고려**:
   - `monitoring_metrics`: 시간 기반 파티셔닝 (월별)
   - `cost_tracking`: 시간 기반 파티셔닝 (월별)

2. **아카이빙 전략**:
   - 오래된 모니터링 데이터는 별도 아카이브 테이블로 이동
   - 완료된 배포의 상세 로그는 압축하여 저장
